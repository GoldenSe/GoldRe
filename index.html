<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Breaker Game with TON Wallet Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/buffer@5.6.0/index.min.js"></script>
    <script>
        window.Buffer = require('buffer').Buffer;
    </script>
    <script type="module">
        import { KeyringImpl, KeyringDBNoop } from "tonutils/keyring";
        import { PrivateKey } from "tonutils/keys";
        import { TonClient, WalletContractV4, internal } from "@ton/ton";
        import { mnemonicNew, mnemonicToPrivateKey } from "@ton/crypto";

        let gold = 0;
        let client;
        let wallet;
        let keyPair;
        let connected = false;

        async function breakBlock() {
            if (connected) {
                gold += 10; // Количество золота за блок
                document.getElementById('gold').innerText = gold;
            } else {
                alert('Пожалуйста, подключите кошелек для игры.');
            }
        }

        async function connectWallet() {
            try {
                // Создание клиента TonClient
                client = new TonClient({ endpoint: 'https://toncenter.com/api/v2/jsonRPC' });

                // Генерация новой пары ключей
                let mnemonics = await mnemonicNew();
                keyPair = await mnemonicToPrivateKey(mnemonics);
                
                // Создание экземпляра кошелька
                wallet = WalletContractV4.create({ workchain: 0, publicKey: keyPair.publicKey });

                // Добавление ключа в keyring
                const keyring = new KeyringImpl(new KeyringDBNoop());
                const privateKey = new PrivateKey(PrivateKey.Ed25519.random().tl());
                await keyring.addKey(privateKey);

                // Получение и отображение адреса кошелька
                const address = wallet.address.toFriendly();
                alert('Кошелек подключен: ' + address);
                connected = true;

                // Проверка и отображение баланса
                await checkBalance();
            } catch (error) {
                console.error('Ошибка подключения кошелька:', error);
                alert('Ошибка подключения кошелька. Проверьте консоль для подробностей.');
            }
        }

        async function checkBalance() {
            if (!wallet) {
                alert('Сначала подключите кошелек.');
                return;
            }
            try {
                const contract = client.open(wallet);
                const balance = await contract.getBalance();
                document.getElementById('balance').innerText = 'Баланс: ' + (balance / 1e9).toFixed(9) + ' TON';
            } catch (error) {
                console.error('Ошибка получения баланса:', error);
            }
        }

        async function sendTransaction() {
            if (!wallet || !keyPair) {
                alert('Сначала подключите кошелек.');
                return;
            }
            try {
                const contract = client.open(wallet);
                const seqno = await contract.getSeqno();
                const transfer = await contract.createTransfer({
                    seqno,
                    secretKey: keyPair.secretKey,
                    messages: [internal({
                        value: '0.01', // сумма перевода в TON
                        to: 'EQDjVXa_oltdBP64Nc__p397xLCvGm2IcZ1ba7anSW0NAkeP', // адрес получателя
                        body: 'Hello world',
                    })]
                });
                alert('Транзакция отправлена!');
            } catch (error) {
                console.error('Ошибка отправки транзакции:', error);
            }
        }
    </script>
</head>
<body>
    <h1>Block Breaker Game with TON Wallet Integration</h1>
    <p>Золото: <span id="gold">0</span></p>
    <p id="balance">Баланс: Неизвестно</p>
    <button onclick="breakBlock()">Разрушить блок</button>
    <button onclick="connectWallet()">Подключить кошелек</button>
    <button onclick="checkBalance()">Проверить баланс</button>
    <button onclick="sendTransaction()">Отправить транзакцию</button>
</body>
</html>
